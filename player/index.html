<html>
<head>
<title>AudioFile Player</title>
<link type="text/css" href="css/redmond/jquery-ui-1.8.12.custom.css" rel="stylesheet" />        
<!-- v1.4.2 of the jquery for some reason allows playlists to work,
	i.e. go from one clip to the next, whereas v1.5.0 doesn't seem
	to work... -->
<script src="js/jquery-1.4.2.min.js"></script>
<!--<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>-->
<script type="text/javascript" src="js/jquery-ui-1.8.12.custom.min.js"></script>
<script src="js/flowplayer-3.2.6.min.js"></script>
<script src="js/flowplayer.playlist-3.0.8.js"></script>
<script type="text/javascript">
function zeroPad(val) {
	if ( val < 10 ) {
		return '0' + val;
	} else {
		return val;
	}
}

// Select another service OR
// Click another date
function reloadTimeList() {
	// Stop player FIXME: Do I really want it to stop at this point?
//	$f("player").stop();

//	var newList = [];

	// Reload time list for selected service and date
	$.ajax({url:"/webservice/basic/listfiles.php",
		datatype:"json",
		data:{
			"service":service,
			"date":dte
		},
		async:false,
		success:function(data) {
			// Clear the playlist first
			$("#timeList").html('');

			// FIXME: Why don't I need this for a static JSON?
			data = $.parseJSON(data)

			// Construct new playlist in HTML
			$.each(data.files, function(key, val) {
				if ( key == 0 ) {
					class_string = ' class="first"'
				} else {
					class_string = ''
				}
				$("#timeList").append(
					'<li class="ui-state-default" href="' +
					'/audio/mp3/' + service +
					'/' + dte + '/' +
					val.file + '"' + class_string + '>' +
					val.title +
					'</li>\n\n'
				);
			});
			$('#timeList li').hover(function(){$(this).addClass('ui-state-hover')},function(){$(this).removeClass('ui-state-hover')});
		}
	});

	// If different service:
	if ( service != oldService ) {
		// Clear mark start and end
		$("#markStart").val('');
		$("#markEnd").val('');
		// Deactivate download button
//		$('input[value="Download Clip"]').attr("disabled", "disabled");
		$('input[value="Download Clip"]').button("disable");
	}

	// Set oldService to current service
	oldService = service;
}

function loadPlayer() {

	$f("player", "flowplayer-3.2.7.swf", {
		clip:{
			onStart:function() {
				timer = setInterval('updateTimer()', 1000)
			},
			onStop:function () {
				clearInterval(timer)
			},
//			autoPlay:false,
			autoBuffer:true
		},
		plugins:{
			audio:{
				url:"flowplayer.audio-3.2.2.swf"
			},
			controls:{
				background: '#5C9CCC',
				height:35,
				width:137,
				left:0,
				all:false,
				play:true,
				mute:true,
				volume:true,
				tooltips:{buttons:true},
				autoHide:false
			},
			controlb:{
				url:"flowplayer.controls-3.2.5.swf",
				background: '#5C9CCC',
				bufferColor: '#E17009',
	                        height:35,
				width:592,
	                        right:111,
				all:false,
				scrubber:true,
//				time:true,
				autoHide:false
			},
			timer:{
				url:"flowplayer.content-3.2.0.swf",
				right:0,
				bottom:0,
				height:35,
				width:111,
				background:'#5C9CCC',
				backgroundGradient:[0.5, 0, 0.3],
				opacity:1,
				border:0,
				borderRadius:0,
				style:{
					".bigger":{
						fontSize:18,
						fontWeight:'bold',
						fontFamily:"verdana,arial,helvetica"
					}
				},
				html:'<span class="bigger">00:00:00</span>'
			}
		}
	}).playlist("#timeList", {
		playingClass:"ui-state-active",
		pausedClass:"ui-state-active",
		loop:true
	});
}


// Click Mark Start / End
function markDownload(subject) {
	// Set the target box
	switch (subject) {
	case 'start':
		target = '#markStart';
		antitarget = '#markEnd';
		break;
	case 'end':
		target = '#markEnd';
		antitarget = '#markStart';
		break;
	}

	// Translate elapsed time to real time
	var file = $f('player').getClip().url;

	yr = file.slice(-26,-22);
	mo = parseInt(file.slice(-21,-19), 10) - 1;
	dy = file.slice(-18,-16);
	ho = file.slice(-15,-13);
	mi = file.slice(-12,-10);
	se = file.slice(-9,-7);
	hs = file.slice(-6,-4);

	value = new Date(yr, mo, dy, ho, mi, se, hs);
	value.setSeconds(value.getSeconds() + $f('player').getTime());

	// Convert this UTC to local time for display in the UI
	value.setMinutes(value.getMinutes() - value.getTimezoneOffset())
	$(target).val(value.getFullYear() + '-' +
		zeroPad(value.getMonth() + 1) + '-' +
		zeroPad(value.getDate()) + '-' +
		zeroPad(value.getHours()) + '-' +
		zeroPad(value.getMinutes()) + '-' +
		zeroPad(value.getSeconds()) + '-' +
		zeroPad(value.getMilliseconds()));

	// Populate relevant mark box
	// If mark end box is populated:
	if ( $(antitarget).val() != '' ) {
		// If mark end > mark start:
		if ( $('#markEnd').val() > $('#markStart').val() ) {
			// activate download button
//			$('input[value="Download Clip"]').removeAttr('disabled');
			$('input[value="Download Clip"]').button('enable');
		} else {
			// clear mark end box
			$(antitarget).val('');
			// deactivate download button
//			$('input[value="Download Clip"]').attr('disabled', 'disabled');
			$('input[value="Download Clip"]').button('disable');
		}
	}
}

// Fill in a mark start or end box
function validateMark(subject) {


}


// Click Download
function downloadAudio() {

	function localToUTC(localTime) {
		
		yr = localTime.slice(-22,-18);
		mo = parseInt(localTime.slice(-17,-15), 10) - 1;
		dy = localTime.slice(-14,-12);
		ho = localTime.slice(-11,-9);
		mi = localTime.slice(-8,-6);
		se = localTime.slice(-5,-3);
		hs = localTime.slice(-2,-0);

		value = new Date(yr, mo, dy, ho, mi, se, hs);
	        value.setMinutes(value.getMinutes() + value.getTimezoneOffset());
		return value.getFullYear() + '-' +
                zeroPad(value.getMonth() + 1) + '-' +
                zeroPad(value.getDate()) + '-' +
                zeroPad(value.getHours()) + '-' +
                zeroPad(value.getMinutes()) + '-' +
                zeroPad(value.getSeconds()) + '-' +
                zeroPad(value.getMilliseconds());
	}

	// Translate mark start and end into UTC
	startMarkUTC = localToUTC($('#markStart').val());
	endMarkUTC = localToUTC($('#markEnd').val());

	// Call download webservice
	url = "http://audiofile.rte.ie/webservice/basic/download.php" +
		"?service=" + service +
		"&start=" + startMarkUTC +
		"&end=" + endMarkUTC;
//	alert(url);
	window.location = url
}

function serviceChange(listItem, newService) {
	if ( newService == service ) { return false }
//	$('#service').children().removeClass('ui-state-active')
	$(listItem).siblings().removeClass('ui-state-active')
	$(listItem).addClass('ui-state-active')
	service = newService;
	$f('player').stop();
	reloadTimeList();
	alert($f('player').getPlaylist());
}

function updateTimer() {
//	$.each($f('player').getPlugin('timer'), function(key, val) { alert(key + ' ' + val)});
	// Translate elapsed time to real time
	var file = $f('player').getClip().url;

	yr = file.slice(-26,-22);
	mo = parseInt(file.slice(-21,-19), 10) - 1;
	dy = file.slice(-18,-16);
	ho = file.slice(-15,-13);
	mi = file.slice(-12,-10);
	se = file.slice(-9,-7);
	hs = file.slice(-6,-4);

	value = new Date(yr, mo, dy, ho, mi, se, hs);
	value.setSeconds(value.getSeconds() + $f('player').getTime());

	// Convert this UTC to local time for display in the UI
	value.setMinutes(value.getMinutes() - value.getTimezoneOffset())
	$f('player').getPlugin('timer').setHtml('<span class="bigger">' +
		zeroPad(value.getHours()) + ':' +
		zeroPad(value.getMinutes()) + ':' +
		zeroPad(value.getSeconds()) + '</span>');
}
</script>
<script type="text/javascript">
// Set initial variables
var oldService = '';
var service = 'radio1';

var dte = new Date;
dte = dte.getFullYear() + '-' +
	zeroPad(dte.getMonth() + 1) + '-' +
	zeroPad(dte.getDate());

var timer = 0;

$(function() {
	//FIXME
/*	$('#service').click(function(tst) {
		var options = this.children;
		for(var i=0; i < options.length; i++){
			options[i].style.color = 'white';
		}
		var selected = this.children[this.selectedIndex];
		selected.style.background-color = 'red';
	});
*/
	$('input:button').button();

	$('#calendar').datepicker({
		inline:true,
		dateFormat:"yy-mm-dd",
		onSelect:function(newDate) {
			dte = newDate;
			reloadTimeList();
		}
	});
	reloadTimeList();
//	alert($('#timeList').html());
	loadPlayer();

	$('#service li').hover(function(){$(this).addClass('ui-state-hover')},function(){$(this).removeClass('ui-state-hover')});

//	timer = setInterval(updateTimer(), 1000);
});

// Input: service, date, time
// Initialisation
// Load page
// Load player
//$(function() {
//////////////////////////});
// If service: | radio1
//	Auto-Select service from list

// If date: | today
//	Highlight date in calendar

// Load time list for service and date

// If time:
//	Find the file for time
//	Calc offset of time from start of file
//	Play from offset
// End initialisation

// ## User actions
//player.playlist("#timeList", {loop:true});

</script>
<style>
#service, #timeList {
	float: left;
	margin: 0 0.5em;
	height: 263px;
	width: 270px;
	overflow: auto;
	padding: 0;
}
#service li, #timeList li {
	list-style: none;
	margin: 0.2em;
	cursor: pointer
}
#timeList li {
	text-align: center;
}
.mark-text {
	margin: 0;
	height: 1.8em;
	width: 210px;
	text-align: center;
}
</style>
</head>
<body>
<div class="player" id="player" style="width: 840px; height: 350px"></div>

<!--<div>
<span>Date: DD/MM/YYYY</span><span>File: YYYY-MM-DD-HH-mm-ss-hh.mp3</span>
<span>Time: HH:mm:ss.hh</span>
</div>-->

<input type="button" value="Clip Start" onClick="markDownload('start')" />
<input type="text" id="markStart" class="ui-widget ui-widget-content ui-corner-all mark-text" style="color:#808000" disabled="disabled" />
<input type="button" value="Clip End" onClick="markDownload('end')" />
<input type="text" id="markEnd" class="ui-widget ui-widget-content ui-corner-all mark-text" style="color:#cc0000" disabled="disabled" />
<input type="button" value="Download Clip" onClick="downloadAudio()" />
<!-- <input type="button" value="Show me the service!" onClick="alert(service)" />-->

<br style="clear:both" />

<ul id="service" class="ui-widget ui-widget-content ui-helper-clearfix ui-corner-all" size="11">
	<li class="ui-state-default ui-state-active" onClick="serviceChange(this, 'radio1')">RTÉ Radio 1 FM</li>
        <li class="ui-state-default" onClick="serviceChange(this, '2fm')">RTÉ 2fm</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'lyricfm')">RTÉ lyric fm</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'rnag')">RTÉ Raidió na Gaeltachta</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'gold')">RTÉ Gold</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'choice')">RTÉ Choice</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'junior-chill')">RTÉ Junior-Chill</li>
        <li class="ui-state-default" onClick="serviceChange(this, '2xm')">RTÉ 2XM</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'rtepulse')">RTÉ Pulse</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'rteradio1extra')">RTÉ Radio 1 extra</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'radio1lw')">RTÉ Radio 1 LW</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'todayfm')">Today fm</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'newstalk')">Newstalk</li>
        <li class="ui-state-default" onClick="serviceChange(this, 'spin1038')">Spin 103.8</li>
</ul>

<div id="calendar" style="float:left"></div>

<ul id="timeList" class="ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></ul>

<br style="clear:both" />

<div class="ui-widget" style="clear:both;margin-top:2em;font-size:0.8em">
	<div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
		<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		Times out-of-sync between browsers???</p>
		<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		AnaLogger Recordings make flowplayer scrubber act strange. To locate the correct audio, you must locate it with the scrubber tooltips which are correct while the audio is buffering, then you must wait for the audio to finnish buffering, and finally click on the scrubber. getTime returns the wrong time consistently (during and post buffering).</p>
		<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		Scrubbing to latter parts of a clip can result in a huge delay!</p>
		<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		Player sometimes stops - I think it's after changing too rapidly between files, but not all that rapidly!</p>
		<p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		Change of service should also unload the present clip and load the first clip of the new playlist.</p>
	</div>
</div>

</body>
</html>
